worker_processes  64;
events {
    worker_connections  2048;
}

http {
    include       mime.types;  # 确保包含了 mime.types 文件
    default_type  application/octet-stream;

    server {
        listen       80;
        server_name  103.189.154.211;

        # 根目录指向网站的主文件夹
        root   C:/livablecityLABWebsite;
        index  index.html index.htm;
    location /main/ {
        proxy_pass http://localhost:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 防止路径重写问题
        rewrite ^/main/(.*)$ /$1 break;
    }
    location /CUG_RS/ {
        rewrite ^/CUG_RS(/.*)$ $1 break;
        proxy_pass http://localhost:3005;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location /SceneGEN_data/ {
        alias E:/SceneGEN_data/;

    autoindex on;   # 是否开启目录浏览

    # CORS 设置
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept' always;

    # 如果前端发 OPTIONS 预检请求，需要返回 204
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        add_header 'Content-Length' 0;
        return 204;
    }
    }
    location /SceneGEN/ {
        rewrite ^/SceneGEN(/.*)$ $1 break;
        proxy_pass http://localhost:3006/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
location /_next/static/chunks/{
        proxy_pass http://10.100.0.164:3001/_next/static/chunks/;
        proxy_set_header Host $host;

    }
location /_next/static/css/{
        proxy_pass http://10.100.0.164:3001/_next/static/css/;
        proxy_set_header Host $host;
    }
location /_next/static/media/{
        proxy_pass http://10.100.0.164:3001/_next/static/media/;
        proxy_set_header Host $host;
    }
location /_next/static/chunks/app/{
        proxy_pass http://10.100.0.164:3001/_next/static/chunks/app/;
        proxy_set_header Host $host;
    }
location /static/{
        proxy_pass http://10.100.0.164:3001/static/;
        proxy_set_header Host $host;
    }

location /sam2_api/ {
        proxy_pass http://10.30.58.75:8000/;  # 注意后面这个 / 保留
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 可选：防止路径重复拼接
        proxy_redirect off;

        # 上传文件大小限制
        client_max_body_size 100M;
    }
location /start-meshroom/ {
        proxy_pass http://10.30.58.75:8003/start-meshroom/;  # 注意后面这个 / 保留
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 可选：防止路径重复拼接
        proxy_redirect off;

        # 上传文件大小限制
        client_max_body_size 100M;
    }
location /task-status/ {
        proxy_pass http://10.30.58.75:8003/task-status/;  # 注意后面这个 / 保留
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 可选：防止路径重复拼接
        proxy_redirect off;

        # 上传文件大小限制
        client_max_body_size 100M;
    }
location /task-result/{
        proxy_pass http://10.30.58.75:8003/task-result/;  # 注意后面这个 / 保留
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 可选：防止路径重复拼接
        proxy_redirect off;

        # 上传文件大小限制
        client_max_body_size 100M;
    }
location /task-list/{
        proxy_pass http://10.30.58.75:8003/task-result/;  # 注意后面这个 / 保留
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 可选：防止路径重复拼接
        proxy_redirect off;

        # 上传文件大小限制
        client_max_body_size 100M;
    }
location /ssr_api/ {
        proxy_pass http://10.30.58.75:8001/;  # 注意后面这个 / 保留
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 可选：防止路径重复拼接
        proxy_redirect off;

        # 上传文件大小限制
        client_max_body_size 1000M;
    }
location /api/{
        proxy_pass http://10.100.0.164:3001/api/;
        proxy_set_header Host $host;
    }
location /Test_image/{
        proxy_pass http://10.100.0.164:3001/Test_image/;
        proxy_set_header Host $host;
    }
  location /BeautyofArchitecture{
        proxy_pass http://10.100.0.164:3001/BeautyofArchitecture;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 防止路径重写问题

    }
        location /mode-selection {
            return 301 /BeautyofArchitecture;
        }
 location /test{
        proxy_pass http://10.100.0.164:3001/test;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 防止路径重写问题

    }
 location /results{
        proxy_pass http://10.100.0.164:3001/results;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 防止路径重写问题

    }
# NSNC

location /SpaceSyntax/{
        proxy_pass http://10.100.0.164:5174/SpaceSyntax/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 防止路径重写问题

    }

# global_tin (SeamlessPlanet)
location /SeamlessPlanet/{
        proxy_pass http://10.100.0.164:5175/SeamlessPlanet/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 防止路径重写问题

    }

        # 代理根目录请求到 https://10.30.58.75:443/styles/OSM%20OpenMapTiles/
        location / {
            proxy_pass https://10.30.58.75:443/;  # 将根目录的请求代理到 https://10.30.58.75:443
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_read_timeout 90;
            proxy_send_timeout 90;
            proxy_buffering off;
        }

        # 代理 /HKUSTGZ_3D 路径请求到 http://10.30.58.75:8082/
        location /HKUSTGZ_3D/ {
            proxy_pass http://10.30.58.75:8082/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_read_timeout 90;
            proxy_send_timeout 90;
            proxy_buffering off;

            sub_filter_once off;
        }

# 代理 /tilesets/ 路径请求到 http://10.30.58.75:8084/
        location /tilesets/ {
            proxy_pass http://10.30.58.75:8084/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_read_timeout 90;
            proxy_send_timeout 90;
            proxy_buffering off;

            sub_filter_once off;
        }


    location /MapGEN3D/ {
        proxy_pass http://10.30.58.75:8081/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
    # 保持路径前缀
    proxy_set_header X-Script-Name /MapGEN3D;
    proxy_set_header X-Original-URI $request_uri;
    }
        
# 映射每个子目录到对应的文件夹
        location /alexander {
            alias C:/livablecityLABWebsite/alexander;
            index index.html index.htm;
        }
        location /static_file {
            alias C:/livablecityLABWebsite/static_file;
        }
        location /arcgis {
            alias C:/livablecityLABWebsite/arcgis;
            index index.html index.htm;
        }

        location /arcgis0 {
            alias C:/livablecityLABWebsite/arcgis0;
            index index.html index.htm;
        }

        location /ArchitectureEducationDeclares {
            alias C:/livablecityLABWebsite/ArchitectureEducationDeclares;
            index index.html index.htm;
        }

        location /archive {
            alias C:/livablecityLABWebsite/archive;
            index index.html index.htm;
        }

        location /aspnet_client {
            alias C:/livablecityLABWebsite/aspnet_client;
            index index.html index.htm;
        }

        location /BinJiang {
            alias C:/livablecityLABWebsite/BinJiang;
            index index.html index.htm;
        }

        location /ChinaNR {
            alias C:/livablecityLABWebsite/ChinaNR;
            index index.html index.htm;
        }

        location /COVID19 {
            alias C:/livablecityLABWebsite/COVID19;
            index index.html index.htm;
        }

        location /Frankfurt {
            alias C:/livablecityLABWebsite/Frankfurt;
            index index.html index.htm;
        }

        location /geomaticsprogram {
            alias C:/livablecityLABWebsite/geomaticsprogram;
            index index.html index.htm;
        }

        location /idaho {
            alias C:/livablecityLABWebsite/idaho;
            index index.html index.htm;
        }

        location /inetpub {
            alias C:/livablecityLABWebsite/inetpub;
            index index.html index.htm;
        }

        location /mapdata {
            alias C:/livablecityLABWebsite/mapdata;
            index index.html index.htm;
        }

        location /MapGEN {
            alias C:/livablecityLABWebsite/MapGEN;
            index index.html index.htm;
        }

        location /movingbehavior {
            alias C:/livablecityLABWebsite/movingbehavior;
            index index.html index.htm;
        }

        location /Pakistan {
            alias C:/livablecityLABWebsite/Pakistan;
            index index.html index.htm;
        }

        location /SWECITIES {
            alias C:/livablecityLABWebsite/SWECITIES;
            index index.html index.htm;
        }

        location /SwedenRoads {
            alias C:/livablecityLABWebsite/SwedenRoads;
            index index.html index.htm;
        }

        location /UKHS {
            alias C:/livablecityLABWebsite/UKHS;
            index index.html index.htm;
        }

        location /USCities {
            alias C:/livablecityLABWebsite/USCities;
            index index.html index.htm;
        }

        location /USCitiesall {
            alias C:/livablecityLABWebsite/USCitiesall;
            index index.html index.htm;
        }

        location /USCitiesOld {
            alias C:/livablecityLABWebsite/USCitiesOld;
            index index.html index.htm;
        }

        location /Warsaw {
            alias C:/livablecityLABWebsite/Warsaw;
            index index.html index.htm;
        }

        location /WarsawMVT {
            alias C:/livablecityLABWebsite/WarsawMVT;
            index index.html index.htm;
        }
        location /another_site {
            alias C:/livablecityLABWebsite/another_site;
            index index.html index.htm;
        }
        location /sea_level_rise_map {
            alias C:/livablecityLABWebsite/sea_level_rise_map;
            index index.html index.htm;
        }
        location /MapGEN2/ {
            return 301 https://$host/styles/OSM%20OpenMapTiles/;
        }

        # 错误页面配置
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        error_page 400 401 403 404 /40x.html;
        location = /40x.html {
            root   html;
        }
    }
}
